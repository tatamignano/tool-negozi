<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaWorld Store Tool - Dashboard</title>
  <style>
    :root { --mw-red: #ed1c24; --bg: #f4f7f6; --text: #333; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
    
    header { background: var(--mw-red); color: white; padding: 1rem 2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    header h1 { margin: 0; font-size: 1.5rem; }

    .main-container { display: flex; flex: 1; overflow: hidden; padding: 1.5rem; gap: 1.5rem; }
    .col { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; padding: 1.5rem; }
    
    /* Colonna 1: Istruzioni */
    .col-setup { flex: 0 0 320px; }
    .step { margin-bottom: 1.5rem; border-left: 3px solid var(--mw-red); padding-left: 1rem; }
    .step h3 { margin: 0 0 0.5rem 0; font-size: 1rem; }
    textarea#bmCode { width: 100%; height: 80px; font-size: 10px; font-family: monospace; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: none; background: #fafafa; box-sizing: border-box; }
    
    /* Colonna 2: Selezione */
    .col-selection { flex: 1; overflow-y: auto; }
    .region { margin-bottom: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; }
    .city-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; margin-top: 0.8rem; }
    .city { font-size: 0.85rem; display: flex; align-items: center; gap: 8px; cursor: pointer; }

    /* Colonna 3: Output */
    .col-output { flex: 0 0 350px; }
    pre#outputHtml { background: #2d2d2d; color: #76ff03; padding: 1rem; border-radius: 4px; flex: 1; overflow: auto; font-size: 12px; margin: 0; }

    /* UI Elements */
    #status { padding: 10px; border-radius: 4px; font-size: 0.85rem; margin-bottom: 1rem; text-align: center; font-weight: bold; }
    .status-waiting { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .status-ready { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    
    button { cursor: pointer; border: none; border-radius: 4px; padding: 8px 12px; font-weight: bold; transition: 0.3s; }
    .btn-primary { background: var(--mw-red); color: white; width: 100%; }
    .btn-secondary { background: #6c757d; color: white; font-size: 0.75rem; }
    .btn-copy { background: #28a745; color: white; width: 100%; margin-bottom: 10px; }
    .btn-group { display: flex; gap: 5px; margin-bottom: 10px; }
  </style>
</head>
<body>

<header>
  <h1>MediaWorld List Generator</h1>
</header>

<div class="main-container">
  <div class="col col-setup">
    <h2>‚öôÔ∏è Setup</h2>
    <div class="step">
      <h3>1. Crea il pulsante</h3>
      <p style="font-size:0.8rem">Crea un preferito nella barra del browser, chiamalo "Estrai Store" e incolla questo codice come URL:</p>
      <textarea id="bmCode" readonly></textarea>
      <button class="btn-primary" id="btnCopyBM" onclick="copyBM()" style="margin-top:8px">Copia Codice</button>
    </div>
    <div class="step">
      <h3>2. Estrai i dati</h3>
      <p style="font-size:0.8rem">Vai su <a href="https://www.mediaworld.it/it/store/store-finder" target="_blank">MediaWorld Store Finder</a> e clicca sul preferito creato.</p>
    </div>
    <div id="status" class="status-waiting">In attesa di dati...</div>
  </div>

  <div class="col col-selection">
    <h2>üìç Seleziona Negozi</h2>
    <div class="btn-group">
      <button class="btn-secondary" onclick="toggleAll(true)">Seleziona Tutti</button>
      <button class="btn-secondary" onclick="toggleAll(false)">Deseleziona Tutti</button>
    </div>
    <div id="regionsContainer">
      <p style="color:#999; text-align:center; margin-top:40px;">Usa il bookmarklet sulla pagina MediaWorld per caricare qui la lista dei negozi.</p>
    </div>
  </div>

  <div class="col col-output">
    <h2>üìÑ Codice HTML</h2>
    <button class="btn-copy" id="btnGenerate" onclick="generateOutput()">Genera Codice</button>
    <button class="btn-primary" id="btnCopyOutput" onclick="copyOutput()" style="background:#444; margin-bottom:10px">Copia HTML Finale</button>
    <pre id="outputHtml"></pre>
  </div>
</div>

<script>
let parsedData = [];

// Il codice del Bookmarklet aggiornato col tuo URL
const bookmarkletCode = `javascript:(function(){const accordions=document.querySelectorAll('[data-test="accordion-header"]');const result=[];function titleCase(str){return str.toLowerCase().split(' ').map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(' ')}accordions.forEach(header=>{const regionName=header.textContent.replace(/\\(\\d+\\)\\s*$/, '').trim();const wrapper=header.closest('li');if(!wrapper)return;const ul=wrapper.querySelector('ul');if(!ul)return;const stores=[];ul.querySelectorAll('li a').forEach(a=>{const name=titleCase(a.textContent.trim());let href=a.getAttribute('href')||'';if(href&&href.startsWith('/')){href='https://www.mediaworld.it'+href}stores.push({name,href})});if(stores.length){result.push({regionName,stores})}});if(result.length>0){const toolUrl='https://tatamignano.github.io/tool-negozi/';const win=window.open(toolUrl,'mw_tool');if(!win){alert('Popup bloccato! Abilita i popup nelle impostazioni del browser.');return}setTimeout(()=>{win.postMessage({type:'MW_STORES_DATA',payload:result},'*')},2000)}else{alert('Nessuno store trovato. Assicurati di essere nella pagina Store Finder.');}})();`;
document.getElementById('bmCode').value = bookmarkletCode;

// --- FUNZIONI TOOL ---

function copyBM() {
  const area = document.getElementById('bmCode');
  area.select();
  navigator.clipboard.writeText(area.value);
  const btn = document.getElementById('btnCopyBM');
  btn.textContent = "‚úÖ Copiato!";
  setTimeout(() => btn.textContent = "Copia Codice", 2000);
}

// Ricezione dati dal Bookmarklet
window.addEventListener('message', function(event) {
  if (event.data && event.data.type === 'MW_STORES_DATA') {
    parsedData = event.data.payload;
    renderRegionSelector(parsedData);
    const status = document.getElementById('status');
    status.textContent = "‚úÖ Dati Ricevuti!";
    status.className = "status-ready";
  }
});

function renderRegionSelector(data) {
  const container = document.getElementById('regionsContainer');
  container.innerHTML = '';
  data.forEach((region, rIndex) => {
    const div = document.createElement('div');
    div.className = 'region';
    div.innerHTML = `<h4>${region.regionName}</h4>`;
    const list = document.createElement('div');
    list.className = 'city-list';
    region.stores.forEach((store, sIndex) => {
      const label = document.createElement('label');
      label.className = 'city';
      label.innerHTML = `<input type="checkbox" checked data-r="${rIndex}" data-s="${sIndex}"> <span>${store.name}</span>`;
      list.appendChild(label);
    });
    div.appendChild(list);
    container.appendChild(div);
  });
}

function toggleAll(state) {
  document.querySelectorAll('#regionsContainer input').forEach(cb => cb.checked = state);
}

function generateOutput() {
  if (!parsedData.length) return;
  let out = '';
  parsedData.forEach((region, rIndex) => {
    const checks = document.querySelectorAll(`input[data-r="${rIndex}"]:checked`);
    if (checks.length === 0) return;
    out += `<h3>${region.regionName}</h3>\n<ul>\n`;
    checks.forEach(cb => {
      const s = parsedData[rIndex].stores[cb.dataset.s];
      out += `  <li><a href="${s.href}" target="_blank">${s.name}</a></li>\n`;
    });
    out += `</ul>\n\n`;
  });
  document.getElementById('outputHtml').textContent = out.trim();
}

function copyOutput() {
  const content = document.getElementById('outputHtml').textContent;
  if(!content) return;
  navigator.clipboard.writeText(content);
  const btn = document.getElementById('btnCopyOutput');
  btn.textContent = "‚úÖ Copiato negli appunti!";
  setTimeout(() => btn.textContent = "Copia HTML Finale", 2000);
}
</script>
</body>
</html>