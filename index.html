<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ELENCO_MW_STORE.EXE - MediaWorld Store Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    :root { 
      --dos-green: #33ff33; 
      --dos-bg: #000; 
      --dos-border: #33ff33;
    }
    
    * { box-sizing: border-box; text-transform: uppercase; }

    body { 
      font-family: 'VT323', monospace; 
      background-color: var(--dos-bg); 
      color: var(--dos-green); 
      margin: 0; 
      display: flex; 
      flex-direction: column; 
      height: 100vh;
      overflow: hidden;
      font-size: 1.2rem;
    }

    /* Effetto Monitor CRT */
    body::before {
      content: " ";
      display: block;
      position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%);
      z-index: 9999;
      background-size: 100% 3px;
      pointer-events: none;
    }

    header { 
      border-bottom: 2px solid var(--dos-border); 
      padding: 10px 20px; 
      background: var(--dos-green); 
      color: var(--dos-bg);
      flex-shrink: 0;
    }

    h1 { margin: 0; font-size: 1.8rem; }

    .main-container { 
      display: flex; 
      flex: 1; 
      overflow: hidden; 
      padding: 1rem; 
      gap: 1rem; 
      padding-bottom: 60px;
    }

    .col { 
      border: 2px solid var(--dos-border); 
      display: flex; 
      flex-direction: column; 
      padding: 1.2rem 1rem 1rem 1rem; /* Aumentato padding top */
      position: relative;
    }

    /* Fix del Titolo Nascosto */
    .col h2 {
      position: absolute;
      top: -14px;
      left: 10px;
      background: var(--dos-bg);
      padding: 0 10px;
      font-size: 1.2rem;
      margin: 0;
      z-index: 5;
    }

    .col-setup { flex: 0 0 320px; }
    
    /* Fix Overflow Selezione */
    .col-selection { flex: 1; }
    #regionsContainer { 
      flex: 1; 
      overflow-y: auto; 
      margin-top: 10px;
      padding-right: 10px;
    }

    .region { margin-bottom: 1.5rem; border-top: 1px dashed var(--dos-green); padding-top: 10px; }
    .region-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .region-header h4 { margin: 0; }
    .btn-mini { font-size: 0.8rem; padding: 2px 5px; margin: 0; }

    .city-list { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
      gap: 5px; 
    }
    .city { font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; }
    .city input { accent-color: var(--dos-green); margin-right: 10px; cursor: pointer; }

    .col-output { flex: 0 0 350px; }
    pre#outputHtml { 
      border: 1px solid var(--dos-green); 
      background: rgba(51, 255, 51, 0.05); 
      color: var(--dos-green); 
      padding: 10px; 
      flex: 1; 
      overflow: auto; 
      font-size: 1rem; 
      margin-top: 10px;
    }

    #status { padding: 5px; margin-top: 10px; text-align: center; border: 1px solid var(--dos-green); }
    .status-waiting { animation: pulse 1.5s infinite; }
    .status-ready { background: var(--dos-green); color: var(--dos-bg); }

    button { 
      background: transparent; 
      color: var(--dos-green); 
      border: 2px solid var(--dos-green); 
      font-family: 'VT323', monospace; 
      font-size: 1.2rem; 
      cursor: pointer; 
      margin-bottom: 10px; 
      padding: 5px;
    }
    button:hover { background: var(--dos-green); color: var(--dos-bg); }

    .feedback-btn { 
      position: fixed; bottom: 20px; right: 20px; 
      border: 1px solid var(--dos-green); background: var(--dos-bg); 
      color: var(--dos-green); padding: 10px 15px; 
      text-decoration: none; z-index: 10000;
    }
    .feedback-btn:hover { background: var(--dos-green); color: var(--dos-bg); }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--dos-bg); border-left: 1px solid var(--dos-green); }
    ::-webkit-scrollbar-thumb { background: var(--dos-green); }
  </style>
</head>
<body>

<header>
  <h1>SYSTEM_LOAD: ELENCO_MW_STORE.EXE (V2.0)</h1>
</header>

<div class="main-container">
  <div class="col col-setup">
    <h2>[ 01-SETUP ]</h2>
    <p>> 1. INSTALLA BOOKMARKLET:</p>
    <textarea id="bmCode" readonly style="width:100%; height:80px; background:transparent; color:var(--dos-green); border:1px solid var(--dos-border); font-family:'VT323'; padding:5px; resize:none;"></textarea>
    <button id="btnCopyBM" onclick="copyBM()" style="width:100%; margin-top:10px;">COPY_DATA_STRING</button>
    <p>> 2. ESEGUI ESTRAZIONE SU STORE_FINDER</p>
    <div id="status" class="status-waiting">SISTEMA_IN_ATTESA...</div>
  </div>

  <div class="col col-selection">
    <h2>[ 02-STORE_SELECTOR ]</h2>
    <div class="btn-group">
      <button onclick="toggleAll(true)">[ SELECT_ALL ]</button>
      <button onclick="toggleAll(false)">[ DESELECT_ALL ]</button>
    </div>
    <div id="regionsContainer">
      <p style="text-align:center; margin-top:40px;">NESSUN DATO RILEVATO.</p>
    </div>
  </div>

  <div class="col col-output">
    <h2>[ 03-HTML_OUTPUT ]</h2>
    <button onclick="generateOutput()" style="width:100%">GENERA_CODICE.BAT</button>
    <button id="btnCopyOutput" onclick="copyOutput()" style="width:100%">COPY_TO_CLIPBOARD</button>
    <pre id="outputHtml">PROMPT_READY></pre>
  </div>
</div>

<a href="mailto:antonio.mignano@idntt.ch?subject=Feedback Tool Store" class="feedback-btn">SEND_FEEDBACK.MAIL</a>

<script>
let parsedData = [];

// Bookmarklet Code
const bookmarkletCode = `javascript:(function(){const accordions=document.querySelectorAll('[data-test="accordion-header"]');const result=[];function titleCase(str){return str.toLowerCase().split(' ').map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(' ')}accordions.forEach(header=>{const regionName=header.textContent.replace(/\\(\\d+\\)\\s*$/, '').trim();const wrapper=header.closest('li');if(!wrapper)return;const ul=wrapper.querySelector('ul');if(!ul)return;const stores=[];ul.querySelectorAll('li a').forEach(a=>{const name=titleCase(a.textContent.trim());let href=a.getAttribute('href')||'';if(href&&href.startsWith('/')){href='https://www.mediaworld.it'+href}stores.push({name,href})});if(stores.length){result.push({regionName,stores})}});if(result.length>0){const toolUrl='https://tatamignano.github.io/tool-negozi/';const win=window.open(toolUrl,'mw_tool');if(!win){alert('Popup bloccato!');return}setTimeout(()=>{win.postMessage({type:'MW_STORES_DATA',payload:result},'*')},2000)}else{alert('Nessuno store trovato.');}})();`;
document.getElementById('bmCode').value = bookmarkletCode;

function copyBM() {
  const area = document.getElementById('bmCode');
  area.select();
  navigator.clipboard.writeText(area.value);
  document.getElementById('btnCopyBM').textContent = "✅ SUCCESS_COPY";
}

window.addEventListener('message', function(event) {
  if (event.data && event.data.type === 'MW_STORES_DATA') {
    parsedData = event.data.payload;
    renderRegionSelector(parsedData);
    const status = document.getElementById('status');
    status.textContent = "READY: DATI_RICEVUTI";
    status.className = "status-ready";
  }
});

function renderRegionSelector(data) {
  const container = document.getElementById('regionsContainer');
  container.innerHTML = '';
  data.forEach((region, rIndex) => {
    const div = document.createElement('div');
    div.className = 'region';
    div.innerHTML = `
      <div class="region-header">
        <h4>> ${region.regionName}</h4>
        <button class="btn-mini" onclick="toggleRegion(${rIndex}, true)">[ ALL ]</button>
        <button class="btn-mini" onclick="toggleRegion(${rIndex}, false)">[ NONE ]</button>
      </div>
    `;
    const list = document.createElement('div');
    list.className = 'city-list';
    region.stores.forEach((store, sIndex) => {
      const label = document.createElement('label');
      label.className = 'city';
      label.innerHTML = `<input type="checkbox" checked data-r="${rIndex}" data-s="${sIndex}"> <span>${store.name}</span>`;
      list.appendChild(label);
    });
    div.appendChild(list);
    container.appendChild(div);
  });
}

function toggleAll(state) {
  document.querySelectorAll('#regionsContainer input').forEach(cb => cb.checked = state);
}

// Nuova funzione per check/uncheck regione singola
function toggleRegion(rIndex, state) {
  document.querySelectorAll(`input[data-r="${rIndex}"]`).forEach(cb => cb.checked = state);
}

function generateOutput() {
  if (!parsedData.length) return;
  let out = '';
  parsedData.forEach((region, rIndex) => {
    const checks = document.querySelectorAll(`input[data-r="${rIndex}"]:checked`);
    if (checks.length === 0) return;
    out += `<h3>${region.regionName}</h3>\n<ul>\n`;
    checks.forEach(cb => {
      const s = parsedData[rIndex].stores[cb.dataset.s];
      out += `  <li><a href="${s.href}" target="_blank">${s.name}</a></li>\n`;
    });
    out += `</ul>\n\n`;
  });
  document.getElementById('outputHtml').textContent = out.trim();
}

function copyOutput() {
  const content = document.getElementById('outputHtml').textContent;
  if(!content) return;
  navigator.clipboard.writeText(content);
  document.getElementById('btnCopyOutput').textContent = "✅ CLIPBOARD_SAVED";
}
</script>
</body>
</html>