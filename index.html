<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ELENCO_MW_STORE.EXE - MediaWorld Store Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    :root { 
      --dos-green: #33ff33; 
      --dos-bg: #000; 
      --dos-border: #33ff33;
    }
    
    * { box-sizing: border-box; text-transform: uppercase; }

    /* Utilities container (Back + Feedback) */
    .util-fixed {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      z-index: 10000;
    }

    .back-btn {
      background: var(--dos-bg);
      color: var(--dos-green);
      border: 2px solid var(--dos-green);
      padding: 6px 10px;
      font-family: 'VT323', monospace;
      text-decoration: none;
      transition: background .12s, color .12s;
    }
    .back-btn:hover {
      background: var(--dos-green);
      color: var(--dos-bg);
    }

    body { 
      font-family: 'VT323', monospace; 
      background-color: var(--dos-bg); 
      color: var(--dos-green); 
      margin: 0; 
      display: flex; 
      flex-direction: column; 
      height: 100vh;
      overflow: hidden;
      font-size: 1.2rem;
    }

    body::before {
      content: " ";
      display: block;
      position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%);
      z-index: 9999;
      background-size: 100% 3px;
      pointer-events: none;
    }

    header { 
      border-bottom: 2px solid var(--dos-border); 
      padding: 10px 20px; 
      background: var(--dos-green); 
      color: var(--dos-bg);
      flex-shrink: 0;
    }

    h1 { margin: 0; font-size: 1.8rem; }

    .main-container { 
      display: flex; 
      flex: 1; 
      overflow: hidden; 
      padding: 1rem; 
      gap: 1rem; 
      padding-bottom: 60px;
    }

    .col { 
      border: 2px solid var(--dos-border); 
      display: flex; 
      flex-direction: column; 
      padding: 1.2rem 1rem 1rem 1rem;
      position: relative;
    }

    .col h2 {
      position: absolute;
      top: -14px;
      left: 10px;
      background: var(--dos-bg);
      padding: 0 10px;
      font-size: 1.2rem;
      margin: 0;
      z-index: 5;
    }

    .col-setup { flex: 0 0 320px; }
    .col-selection { flex: 1; }
    #regionsContainer { 
      flex: 1; 
      overflow-y: auto; 
      margin-top: 10px;
    }

    .region { margin-bottom: 1.5rem; border-top: 1px dashed var(--dos-green); padding-top: 10px; }
    .region-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    
    .btn-mini { font-size: 0.8rem; padding: 2px 5px; margin: 0 2px; border-width: 1px; }

    .city-list { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
      gap: 5px; 
    }
    .city { font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; }
    .city input { accent-color: var(--dos-green); margin-right: 10px; }

    .col-output { flex: 0 0 400px; }
    
    /* Contenitori Output */
    .output-section { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    
    pre#outputHtml { 
      border: 1px solid var(--dos-green); 
      background: rgba(51, 255, 51, 0.05); 
      color: var(--dos-green); 
      padding: 10px; 
      flex: 1; 
      overflow: auto; 
      font-size: 0.9rem; 
      margin-top: 5px;
      margin-bottom: 15px;
    }

    #richPreview {
      border: 1px solid var(--dos-green);
      background: white;
      color: black;
      padding: 10px;
      flex: 1;
      overflow: auto;
      font-family: sans-serif; /* Per vedere come apparirà su Word */
      font-size: 14px;
      text-transform: none; /* Mantieni case originale per l'anteprima */
    }

    button { 
      background: transparent; 
      color: var(--dos-green); 
      border: 2px solid var(--dos-green); 
      font-family: 'VT323', monospace; 
      font-size: 1.1rem; 
      cursor: pointer; 
      padding: 5px;
      width: 100%;
      margin-bottom: 5px;
    }
    button:hover { background: var(--dos-green); color: var(--dos-bg); }

    .external-link { color: var(--dos-green); text-decoration: underline; display: block; margin-top: 15px; }

    .feedback-btn { 
      border: 1px solid var(--dos-green); background: var(--dos-bg); 
      color: var(--dos-green); padding: 10px 15px; 
      text-decoration: none;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--dos-bg); border-left: 1px solid var(--dos-green); }
    ::-webkit-scrollbar-thumb { background: var(--dos-green); }
  </style>
</head>
<body>

<header>
<header>
  <h1>SYSTEM_LOAD: ELENCO_MW_STORE.EXE (V2.0)</h1>
</header>

<div class="main-container">
  <div class="col col-setup">
    <h2>[ 01-SETUP ]</h2>
    <p>> 1. INSTALLA BOOKMARKLET:</p>
    <textarea id="bmCode" readonly style="width:100%; height:60px; background:transparent; color:var(--dos-green); border:1px solid var(--dos-border); font-family:'VT323'; padding:5px; resize:none;"></textarea>
    <button id="btnCopyBM" onclick="copyBM()">COPY_DATA_STRING</button>
    
    <p style="margin-top:15px;">> 2. ESEGUI ESTRAZIONE:</p>
    <a href="https://www.mediaworld.it/it/store/store-finder" target="_blank" class="external-link">> APRI STORE_FINDER.URL</a>
    
    <div id="status" class="status-waiting" style="margin-top:20px; border:1px solid var(--dos-green); padding:5px; text-align:center;">SISTEMA_IN_ATTESA...</div>
  </div>

  <div class="col col-selection">
    <h2>[ 02-STORE_SELECTOR ]</h2>
    <div style="display:flex; gap:10px;">
        <button onclick="toggleAll(true)">[ SELECT_ALL ]</button>
        <button onclick="toggleAll(false)">[ DESELECT_ALL ]</button>
    </div>
    <div id="regionsContainer">
      <p style="text-align:center; margin-top:40px;">NESSUN DATO RILEVATO.</p>
    </div>
  </div>

  <div class="col col-output">
    <h2>[ 03-OUTPUT_MODES ]</h2>
    <button onclick="generateOutput()" style="background:var(--dos-green); color:var(--dos-bg); font-weight:bold;">GENERA_TUTTI_FORMATI.BAT</button>
    
    <div class="output-section">
        <label style="font-size:0.8rem;">> FORMATO_HTML_CODE:</label>
        <button id="btnCopyOutput" onclick="copyOutput()" style="font-size:0.9rem">COPY_HTML_SOURCE</button>
        <pre id="outputHtml"></pre>

        <label style="font-size:0.8rem;">> FORMATO_RICH_TEXT (WORD/MAIL):</label>
        <button id="btnCopyRich" onclick="copyRichText()" style="font-size:0.9rem">COPY_FORMATTED_TEXT</button>
        <div id="richPreview"></div>
    </div>
  </div>

</div>

<div class="util-fixed">
  <a href="https://tatamignano.github.io/amhub/" class="back-btn">[ &lt; RETURN_TO_HUB ]</a>
  <a href="mailto:antonio.mignano@idntt.ch?subject=Feedback Tool Store" class="feedback-btn">SEND_FEEDBACK.MAIL</a>
</div>

<script>
let parsedData = [];

const bookmarkletCode = `javascript:(function(){const accordions=document.querySelectorAll('[data-test="accordion-header"]');const result=[];function titleCase(str){return str.toLowerCase().split(' ').map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(' ')}accordions.forEach(header=>{const regionName=header.textContent.replace(/\\(\\d+\\)\\s*$/, '').trim();const wrapper=header.closest('li');if(!wrapper)return;const ul=wrapper.querySelector('ul');if(!ul)return;const stores=[];ul.querySelectorAll('li a').forEach(a=>{const name=titleCase(a.textContent.trim());let href=a.getAttribute('href')||'';if(href&&href.startsWith('/')){href='https://www.mediaworld.it'+href}stores.push({name,href})});if(stores.length){result.push({regionName,stores})}});if(result.length>0){const toolUrl='https://tatamignano.github.io/tool-negozi/';const win=window.open(toolUrl,'mw_tool');if(!win){alert('Popup bloccato!');return}setTimeout(()=>{win.postMessage({type:'MW_STORES_DATA',payload:result},'*')},2000)}else{alert('Nessuno store trovato.');}})();`;
document.getElementById('bmCode').value = bookmarkletCode;

function copyBM() {
  const area = document.getElementById('bmCode');
  area.select();
  navigator.clipboard.writeText(area.value);
  document.getElementById('btnCopyBM').textContent = "✅ SUCCESS";
}

window.addEventListener('message', function(event) {
  if (event.data && event.data.type === 'MW_STORES_DATA') {
    parsedData = event.data.payload;
    renderRegionSelector(parsedData);
    const status = document.getElementById('status');
    status.textContent = "READY: DATI_RICEVUTI";
    status.style.background = "var(--dos-green)";
    status.style.color = "var(--dos-bg)";
  }
});

function renderRegionSelector(data) {
  const container = document.getElementById('regionsContainer');
  container.innerHTML = '';
  data.forEach((region, rIndex) => {
    const div = document.createElement('div');
    div.className = 'region';
    div.innerHTML = `
      <div class="region-header">
        <h4>> ${region.regionName}</h4>
        <div>
            <button class="btn-mini" onclick="toggleRegion(${rIndex}, true)">[ ALL ]</button>
            <button class="btn-mini" onclick="toggleRegion(${rIndex}, false)">[ NONE ]</button>
        </div>
      </div>
    `;
    const list = document.createElement('div');
    list.className = 'city-list';
    region.stores.forEach((store, sIndex) => {
      const label = document.createElement('label');
      label.className = 'city';
      label.innerHTML = `<input type="checkbox" checked data-r="${rIndex}" data-s="${sIndex}"> <span>${store.name}</span>`;
      list.appendChild(label);
    });
    div.appendChild(list);
    container.appendChild(div);
  });
}

function toggleAll(state) {
  document.querySelectorAll('#regionsContainer input').forEach(cb => cb.checked = state);
}

function toggleRegion(rIndex, state) {
  document.querySelectorAll(`input[data-r="${rIndex}"]`).forEach(cb => cb.checked = state);
}

function generateOutput() {
  if (!parsedData.length) return;
  let outHtml = '';
  
  parsedData.forEach((region, rIndex) => {
    const checks = document.querySelectorAll(`input[data-r="${rIndex}"]:checked`);
    if (checks.length === 0) return;
    
    outHtml += `<h3>${region.regionName}</h3>\n<ul>\n`;
    checks.forEach(cb => {
      const s = parsedData[rIndex].stores[cb.dataset.s];
      outHtml += `  <li><a href="${s.href}" target="_blank">${s.name}</a></li>\n`;
    });
    outHtml += `</ul>\n\n`;
  });

  // Aggiorna box Codice
  document.getElementById('outputHtml').textContent = outHtml.trim();
  
  // Aggiorna box Anteprima Visiva (Rich Text)
  document.getElementById('richPreview').innerHTML = outHtml;
}

function copyOutput() {
  const content = document.getElementById('outputHtml').textContent;
  if(!content) return;
  navigator.clipboard.writeText(content);
  document.getElementById('btnCopyOutput').textContent = "✅ HTML_COPIED";
}

function copyRichText() {
  const container = document.getElementById('richPreview');
  if (!container.innerHTML) return;

  const range = document.createRange();
  range.selectNode(container);
  window.getSelection().removeAllRanges();
  window.getSelection().addRange(range);

  try {
    document.execCommand('copy');
    document.getElementById('btnCopyRich').textContent = "✅ FORMAT_COPIED";
  } catch (err) {
    alert('Errore durante la copia');
  }
  
  window.getSelection().removeAllRanges();
  setTimeout(() => document.getElementById('btnCopyRich').textContent = "COPY_FORMATTED_TEXT", 2000);
}
</script>
</body>
</html>